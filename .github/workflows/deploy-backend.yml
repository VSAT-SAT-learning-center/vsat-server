name: Deploy Backend

# Kích hoạt khi có push lên nhánh main
on:
    push:
        branches:
            - main

jobs:
    deploy-backend:
        runs-on: self-hosted  # Sử dụng runner tự quản trên VPS
        environment: docker
        steps:
            # Bước 1: Clone hoặc cập nhật mã nguồn
            - name: Clone or Pull latest code
              run: |
                # Kiểm tra nếu thư mục đã tồn tại
                if [ ! -d "/home/runner/vsat-server" ]; then
                  git clone https://github.com/VSAT-SAT-learning-center/vsat-server.git /home/runner/vsat-server
                fi
                cd /home/runner/vsat-server
                git reset --hard  # Reset mọi thay đổi trước khi pull
                git clean -fd
                git checkout main
                git pull origin main  

            # Bước 2: Cài đặt npm dependencies
            - name: Install npm dependencies
              run: |
                cd /home/runner/vsat-server
                npm install

            # Bước 3: Build project
            - name: Build code
              run: |
                cd /home/runner/vsat-server
                npm run build

            # Bước 4: Tạo file .env với các thông tin cấu hình
            - name: Create .env file
              run: |
                echo "POSTGRES_HOST=103.163.25.160" > /home/runner/vsat-server/.env
                echo "POSTGRES_PORT=5432" >> /home/runner/vsat-server/.env
                echo "POSTGRES_USER=postgres" >> /home/runner/vsat-server/.env
                echo "POSTGRES_DB=vsat" >> /home/runner/vsat-server/.env
                echo "POSTGRES_SYNC=true" >> /home/runner/vsat-server/.env
                echo "POSTGRES_LOGGING=true" >> /home/runner/vsat-server/.env
                echo "MONGO_URI=mongodb://localhost:27017/nest" >> /home/runner/vsat-server/.env
                echo "MAIL_USER=vsat.center.official@gmail.com" >> /home/runner/vsat-server/.env
                echo "ACCESS_TOKEN_KEY=${{ secrets.ACCESS_TOKEN_KEY }}" >> /home/runner/vsat-server/.env
                echo "API_KEY=${{ secrets.API_KEY }}" >> /home/runner/vsat-server/.env
                echo "MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}" >> /home/runner/vsat-server/.env
                echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> /home/runner/vsat-server/.env
                echo "REFRESH_TOKEN_KEY=${{ secrets.REFRESH_TOKEN_KEY }}" >> /home/runner/vsat-server/.env

            # Bước 5: Thiết lập và triển khai với Docker Compose
            - name: Build and Deploy Backend with Docker Compose
              run: |
                cd /home/runner/vsat-server
                docker compose -f compose.yaml up --build -d
